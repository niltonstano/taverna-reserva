# ğŸ· Taverna Reserva â€” API de E-commerce de Alta Performance

API de e-commerce desenvolvida com foco em **resiliÃªncia, consistÃªncia de dados e seguranÃ§a**, utilizando uma arquitetura escalÃ¡vel com **Fastify, MongoDB (Replica Set) e TypeScript**.

O projeto vai alÃ©m do CRUD bÃ¡sico, implementando soluÃ§Ãµes para problemas reais de sistemas distribuÃ­dos, como **concorrÃªncia de estoque e idempotÃªncia de pagamentos**.

---

## ğŸš€ Diferenciais de Engenharia (O que torna este projeto Ãºnico)

Diferente de APIs comuns, este projeto implementa padrÃµes de sistemas de missÃ£o crÃ­tica:

### ğŸ›¡ï¸ ConsistÃªncia de Dados e TransaÃ§Ãµes ACID

Utiliza **MongoDB Replica Set** para garantir transaÃ§Ãµes atÃ´micas. No processo de checkout, a criaÃ§Ã£o do pedido, a baixa de estoque e a limpeza do carrinho ocorrem em uma Ãºnica transaÃ§Ã£o: **ou tudo acontece, ou nada Ã© alterado**.

### âš¡ ProteÃ§Ã£o contra CondiÃ§Ã£o de Corrida (Race Conditions)

O sistema de estoque foi validado com **testes de estresse simultÃ¢neos**. Se 10 usuÃ¡rios tentarem comprar o Ãºltimo item ao mesmo tempo, o sistema garante atravÃ©s de travas lÃ³gicas e transaÃ§Ãµes que apenas 1 consiga, mantendo a integridade do inventÃ¡rio.

### ğŸ”‘ IdempotÃªncia de OperaÃ§Ãµes

ImplementaÃ§Ã£o de **Idempotency Keys** em rotas crÃ­ticas (Checkout). Isso evita que uma falha de conexÃ£o ou um "duplo clique" do usuÃ¡rio resulte em duas cobranÃ§as ou dois pedidos idÃªnticos.

````mermaid
sequenceDiagram
    participant C as Cliente (Frontend)
    participant A as Fastify API (Taverna Engine)
    participant R as Redis/Cache (Lock Layer)
    participant DB as MongoDB (Replica Set)

    Note over C, A: Request 1 (Click Inicial)
    C->>A: POST /checkout (Idempotency-Key: "abc-123")
    A->>R: Verificar/Set Lock ("abc-123")
    R-->>A: Lock Adquirido (OK)

    Note over C, A: Request 2 (Duplo Click Acidental)
    C->>A: POST /checkout (Idempotency-Key: "abc-123")
    A->>R: Verificar Lock ("abc-123")
    R-->>A: Lock Ativo (Em processamento)
    A-->>C: 409 Conflict (OperaÃ§Ã£o em curso)

    Note over A, DB: Processamento Request 1
    A->>DB: Iniciar TransaÃ§Ã£o ACID
    DB->>DB: Baixa Estoque + Criar Pedido
    A->>DB: Commit TransaÃ§Ã£o
    A-->>C: 201 Created (Sucesso)
    A->>R: Liberar Lock / Cachear Resultado

### ğŸ§ª SuÃ­te de Testes Profissional

- **Testes de IntegraÃ§Ã£o:** Validando o fluxo completo com banco de dados em memÃ³ria.
- **Testes de Estresse:** SimulaÃ§Ã£o de mÃºltiplas requisiÃ§Ãµes simultÃ¢neas para validar concorrÃªncia.
- **SeguranÃ§a (Anti-IDOR):** Testes especÃ­ficos que garantem que um usuÃ¡rio nÃ£o consiga acessar dados de terceiros.

---

## ğŸ› ï¸ Stack TecnolÃ³gica

| Tecnologia               | Finalidade                                                       |
| :----------------------- | :--------------------------------------------------------------- |
| **Node.js 22 + Fastify** | Runtime e Framework de alta performance (low overhead).          |
| **TypeScript**           | Desenvolvimento tipado e seguro.                                 |
| **MongoDB + Mongoose**   | Banco NoSQL com modelagem via Schemas e suporte a TransaÃ§Ãµes.    |
| **Zod**                  | ValidaÃ§Ã£o de esquema e contratos de dados (Type-safety runtime). |
| **JWT + Bcrypt**         | AutenticaÃ§Ã£o robusta e seguranÃ§a de credenciais.                 |
| **Melhor Envio API**     | IntegraÃ§Ã£o real para cotaÃ§Ã£o de frete e logÃ­stica.               |
| **Docker & Compose**     | OrquestraÃ§Ã£o de containers para API e Banco de Dados.            |

---

## ğŸ—ï¸ Arquitetura e PadrÃµes de Projeto

A aplicaÃ§Ã£o segue os princÃ­pios de **Clean Architecture** e **SOLID**:

- **Controllers:** Apenas manipulaÃ§Ã£o de entrada e saÃ­da (REQ/RES).
- **Services:** Toda a regra de negÃ³cio, isolada e testÃ¡vel.
- **Repositories:** AbstraÃ§Ã£o da camada de dados (Data Access Layer).
- **Middlewares/Hooks:** Saneamento de dados automÃ¡tico e logs estruturados com **Pino**.

---

## ğŸ“¦ Funcionalidades Principais

- **GestÃ£o de Produtos:** Controle de estoque rigoroso e catÃ¡logo dinÃ¢mico.
- **Checkout Inteligente:** IntegraÃ§Ã£o com **Melhor Envio** para cotaÃ§Ã£o de frete em tempo real baseada em dimensÃµes e peso.
- **RBAC (Role Based Access Control):** NÃ­veis de permissÃ£o distintos para `Admin` e `Customer`.
- **Logs Estruturados:** Monitoramento de saÃºde e erros da API em tempo real.

---
## ğŸ“Š Observabilidade e ResiliÃªncia (Logs e DiagnÃ³sticos)

O projeto utiliza o **Pino** para geraÃ§Ã£o de logs estruturados em JSON. Durante a execuÃ§Ã£o da suÃ­te de testes ou em produÃ§Ã£o, vocÃª poderÃ¡ observar logs de nÃ­vel `WARN (40)` ou `ERROR (50)`.

Ã‰ importante destacar que:
- **Erros Induzidos:** Grande parte desses logs sÃ£o comportamentos esperados e induzidos pelos testes de seguranÃ§a e estresse.
- **ValidaÃ§Ã£o de Bloqueio:** Logs de "Tentativa de acesso nÃ£o autorizado" ou "BLOQUEIO RBAC" confirmam que as camadas de proteÃ§Ã£o estÃ£o interceptando acessos indevidos com sucesso.
- **Controle de ConcorrÃªncia:** Logs de erro em operaÃ§Ãµes de checkout simultÃ¢neas sÃ£o evidÃªncias de que o mecanismo de idempotÃªncia travou uma requisiÃ§Ã£o duplicada para proteger a integridade financeira da operaÃ§Ã£o.

 "Em um sistema resiliente, um log de erro bem rastreado Ã© a prova de que uma falha foi prevista e contida."
---
## ğŸ”§ Como Executar

1. **Clonar o repositÃ³rio:**

   ```bash
   git clone https://github.com/niltonstano/taverna-reserva.git (https://github.com/niltonstano/taverna-reserva.git)

   docker compose up -d --build

   Acessar a documentaÃ§Ã£o Swagger:
   http://localhost:3333/docs
````

ğŸ‘¨â€ğŸ’» Autor
Nilton Alexandre Stano Desenvolvedor Backend com foco em arquiteturas resilientes e performance.

GitHub: https://github.com/niltonstano

http://localhost:8080

npm run test:manual-stress

Para validar tudo: npm test

Para focar em seguranÃ§a/IDOR: npm run test:int

Para verificar o deploy final: npm run test:e2e
